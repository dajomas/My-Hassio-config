  alias: Achtergevel sluiten #Sunscreen down/uitklappen
  initial_state: 'on' #on reboot HA or reloading of automations, automation is ON
  trigger:
    - platform: time_pattern
      minutes: '/5'
      seconds: 00
  condition:
    condition: and # all conditions need to be TRUE before action is executed.
    conditions:

      # Sun based conditions
      - condition: numeric_state
        entity_id: sensor.sun_azimut
        above: 80  # Sun should be above the horizon, not below.
        below: 200
      - condition: numeric_state
        entity_id: sun.sun
        value_template: '{{ state.attributes.elevation }}'
        above: 15  # Sun should be above the horizon, not below.
      - condition: sun
        after: sunrise
        after_offset: 02:00:00 # Sunrise for at least 2 hours
      - condition: sun
        before: sunset
        before_offset: -02:30:00 # Some time before sunset, there's no point in rolling out anymore

      # Weather based conditions
      - condition: numeric_state
        entity_id: sensor.windsnelheid
        below: 20 # Wind strenght - I still have to tune this value
      - condition: numeric_state
        entity_id: sensor.dark_sky_precip_intensity
        below: 0.1 # Almost no rain at the moment
      # - condition: numeric_state
      #   entity_id: sensor.br_precipitation_forecast_total
      #   below: 0.1 # Almost no rain in the next 60 minutes is predicted
      - condition: numeric_state
        entity_id: sensor.dark_sky_uv_index
        above: 3 # This indicates direct sunlight on my location (as in: not cloudy)

      # Temperature based conditions
      - condition: numeric_state
        entity_id: sensor.garage_5_0
        above: 20 # only if outdoor temperature is above x then allowed to roll out
      - condition: numeric_state
        entity_id: sensor.gemiddelde_temp_beneden
        above: 22 # only if indoor temperature is above x then allowed to roll out

        # Time based conditions
      - condition: template
        value_template: '{{ now().month > 3 }}' # Starting April
      - condition: template
        value_template: '{{ now().month < 10 }}' # Ending October
      - condition: template
        value_template:  ' {{ as_timestamp(now()) - as_timestamp(states.automation.achtergevel_sluiten.attributes.last_triggered) | int > 1800}}' # prevents that automation is triggered multiple times in a short amount of time. Checks last time automation is triggered, if more then 1800 seconds (30min), condition becomes TRUE
      - condition: state
        entity_id: input_boolean.achtergevel_closed
        state: 'off'
      # - condition: template
      #   value_template: '{{as_timestamp(states.automation.achtergevel_sluiten.attributes.last_triggered) | int <= as_timestamp(states.automation.achtergevel_openen.attributes.last_triggered) | int }}' # this automation can only be triggered if timestamp of last_triggered time is OLDER than the timestamp of last_triggered time of the "screen up" automation. This condition prevents that the automation is triggered again if sunscreen is already down. Better would be to have a real sensor checking if sunscreen is up or down but currently I don't have a sensor in place. The | int is used to catch the fact that on start up both triggers report 'none' and hence this condition would never become true. The int makes it such that value = 0 for both and hence trigger can be executed.
  action:
    - service: script.achtergevel_sluiten
    - service: notify.ios_gphone
      data:
       message: "Het zonnescherm achtergevel gesloten"